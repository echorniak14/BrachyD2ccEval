# Brachytherapy Plan Evaluator

## Project Overview

This project aims to automate and streamline the evaluation process for High Dose Rate (HDR) brachytherapy plans, specifically for cases planned using **Oncentra**. Currently, the process involves manual data entry from the planning system's Dose Volume Histogram (DVH) table into a separate spreadsheet to calculate Biologic Effective Dose (BED) and Equivalent Dose in 2 Gy fractions (EQD2) for Organs at Risk (OARs) and the target volume. This manual process is time-consuming and prone to human error, especially when plan adjustments require re-entry of data.

The goal is to develop a scripting solution that automates the extraction of relevant dose metrics directly from **DICOM RT Dose and RT Structure Set files** exported from Oncentra. It will then perform BED/EQD2 calculations, incorporate external beam radiation therapy (EBRT) contributions, and compare the total doses against established clinical constraints (e.g., EMBRACE II trial guidelines). The final output will mirror the 'dose summary' report currently generated by the manual spreadsheet process.

## Features

* **Automated DICOM Data Extraction:** Extract D2cc for specified OARs (e.g., Bowel, Sigmoid, Rectum, Bladder, Rectal Pt) and D90/D98 for target volumes (e.g., Pt A, GTV D98, HRCTV D98, HRCTV D90) directly from exported Oncentra DICOM RT Dose and RT Structure Set files.
* **BED & EQD2 Calculation:** Calculate Biologic Effective Dose (BED) and Equivalent Dose in 2 Gy fractions (EQD2) for both brachytherapy and external beam components, replicating the logic from the existing spreadsheet.
* **External Beam Radiation Therapy (EBRT) Integration:** Account for prior or concurrent EBRT doses to OARs and the target.
* **Constraint Evaluation:** Compare calculated total BED/EQD2 values against user-defined or predefined clinical constraints (e.g., EMBRACE II).
* **Clear Reporting:** Provide a comprehensive and easy-to-read summary of dose metrics, calculated BED/EQD2 values, and constraint adherence, structured similarly to the current 'dose summary' report.
* **[FUTURE FEATURE: Data Export:]** Option to export results to a structured file format (e.g., CSV, Excel) for record-keeping or further analysis.
* **[FUTURE FEATURE: Graphical User Interface (GUI):]** A user-friendly interface for easier interaction, removing the need for command-line usage.
* **[FUTURE FEATURE: Iterative Optimization Feedback:]** (Highly ambitious, depends on planning system capabilities) Potentially provide feedback or direct modification capabilities to the planning system for automated plan adjustments based on constraint violations.

## Getting Started

### Prerequisites

* Python 3.13.5 installed on your system.
* Required Python packages: `pydicom`, `pandas`, `numpy`, `openpyxl` (if exporting to `.xlsx`).

    You can install these using pip:
    ```bash
    pip install pydicom pandas numpy openpyxl
    ```

### Installation

1.  Clone this repository:
    ```bash
    git clone https://github.com/echorniak14/BrachyD2ccEval.git
    cd brachytherapy-plan-evaluator
    ```

2.  [Optional: Create a virtual environment]
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows: `venv\Scripts\activate`
    ```

3.  Install the required Python packages (if not already done in prerequisites):
    ```bash
    pip install -r requirements.txt
    ```
    (You'll create a `requirements.txt` file later containing all dependencies.)

### Usage

1.  **Prepare Input Files:**
    Export the **DICOM RT Dose** and **DICOM RT Structure Set** files from Oncentra for the plan you wish to evaluate. Ensure these files are saved in a known directory.
    *Example: `C:\Plans\PatientXYZ\` containing `RT_Dose.dcm` and `RT_Struct.dcm`*

2.  **Run the Script:**
    Open your terminal or command prompt, navigate to the project directory, and run the main script:

    ```bash
    python main.py --dose_dicom_file "path/to/your/RT_Dose.dcm" --struct_dicom_file "path/to/your/RT_Struct.dcm" [--ebrt_received True/False] [--ebrt_dose 45] [--output_csv "path/to/output.csv"]
    ```

    **Command-line Arguments:**
    * `--dose_dicom_file <path_to_file>` (Required): Path to the exported DICOM RT Dose file.
    * `--struct_dicom_file <path_to_file>` (Required): Path to the exported DICOM RT Structure Set file.
    * `--ebrt_received <True/False>` (Optional, default: `False`): Specify `True` if the patient has received external beam radiation therapy.
    * `--ebrt_dose <dose_in_Gy>` (Optional, default: `45`): The prescription dose of the external beam radiation therapy in Gray (Gy), typically assumed to be received by OARs. Only relevant if `--ebrt_received` is `True`.
    * `--output_csv <path_to_csv>` (Optional): If provided, the results will be saved to this CSV file, formatted similar to your existing 'dose summary'.

    **Example:**
    ```bash
    python main.py --dose_dicom_file "C:\HDR_Plans\Patient_A\RT_Dose.dcm" --struct_dicom_file "C:\HDR_Plans\Patient_A\RT_Struct.dcm" --ebrt_received True --ebrt_dose 50 --output_csv "C:\HDR_Plans\Patient_A\Plan_Eval_Summary.csv"
    ```

3.  **Review Output:**
    The script will print the evaluated plan details to the console, including D2cc, D90/D98, calculated BED/EQD2 values, and a summary of constraint adherence.
    If `--output_csv` was specified, check the generated CSV file for the 'dose summary' report.

## Configuration

The following parameters can be configured in `config.py`:

* **Alpha/Beta Ratios:** Define the $\alpha/\beta$ ratios for various organs and tumor types. These values can be extracted from your sample spreadsheets (e.g., "a/b [Gy]" column).
    * Example:
        ```python
        # config.py
        ALPHA_BETA_RATIOS = {
            "Rectum": 3.0,
            "Bladder": 4.0,
            "Sigmoid": 3.0,
            "Small Bowel": 3.0,
            "Target_HRCTV": 10.0,
            "Target_GTV": 10.0,
            "Patient_A_Target": 10.0, # Example for a specific target like 'Pt A'
            # ... and so on for all relevant structures
        }
        ```
* **EMBRACE II Constraints:** Define the BED and/or EQD2 constraints for OARs and target.
    * Example:
        ```python
        # config.py
        EMBRACE_CONSTRAINTS_EQD2 = {
            "Rectum": 75.0,  # Max EQD2 for Rectum
            "Bladder": 80.0, # Max EQD2 for Bladder
            # ... and so on for other OARs and potentially target
        }
        ```

    [**Action Item for Developer:** You will need to create this `config.py` file and define these parameters within it, mapping to the structure names in your DICOM files.]

## Project Structure